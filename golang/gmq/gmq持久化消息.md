# 持久化消息
> 持久化即将内存数据保存到磁盘,其目的是为了保证消息的可靠性,例如gmq发生意外以后中断退出时,消息不会丢失

## 配置
目前gmq的持久化策略类似于redis的`RDB快照`策略,通过设置阀值,当达到临界点时来启动持久化
```
// gmq/cmd/gnode/conf.ini
[node]
bgsave.BGSave="30-100,150-10,300-1"
```
以上是持久化的阀值设置,每一个`topic`都可以决定是否启用持久化操作,默认情况下是不启动,可以通过订阅`topic时`,设置`topic.isPersist`为`true`,如下:
```go
cfg := gmq.NewProducerCfg()
p := gmq.NewProducter(cfg)
topic := p.NewTopic(true, true) // 第一个参数为持久化,第二个参数为自动确认消息 
topic.publish(job)
```
说明:
```
30-100 // 当30秒内有100条新消息产生时,执行落盘操作
150-10 // 当150秒内有10条新消息产生时,执行落盘操作
300-1  // 当300秒内有1条新消息产生时,执行落盘操作
```
执行顺序是从上到下,当满足某个条件后执行落盘操作,例如当满足`30-100`条件时,执行一次落盘,然后重新计时,当再次满足`30-100`时,再次落盘

## 注意
- 可靠性和性能是相对的,执行持久化操作会影响性能,所以不应该把阀值设置太低,但是相对的也会增加消息丢失可能性,目前gmq的持久化策略是比较粗糙,并不能保证消息可靠性,待优化
- 延迟队列和等待确认队列目前还不支持持久化操作,这对延迟消息和被消费后待确认的消息没有任何保证,待优化

## 链接
- https://github.com/wuzhc/gmq